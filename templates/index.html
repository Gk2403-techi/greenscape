<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenScape AI | Professional Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { serif: ['"Playfair Display"', 'serif'], sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { botanical: { 900: '#022c22', 800: '#064e3b', 500: '#10b981' }, neon: { lime: '#a3e635' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        #home > div { will-change: transform, opacity; } /* Performance hint for parallax */
        .chat-msg { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="antialiased selection:bg-neon-lime selection:text-botanical-900" data-current-state="{{ current_state | tojson | safe if current_state else '{}' }}">

    <nav class="fixed top-0 w-full z-50 p-4">
        <div class="glass-panel container mx-auto px-6 py-3 rounded-full flex justify-between items-center shadow-2xl">
            <a href="/" class="flex items-center gap-3">
                <div class="relative w-10 h-10 bg-gradient-to-tr from-botanical-500 to-neon-lime rounded-xl flex items-center justify-center">
                    <i class="fas fa-leaf text-botanical-900 text-xl"></i>
                </div>
                <span class="font-serif text-2xl font-bold text-white tracking-wide">Green<span class="text-neon-lime">Scape</span></span>
            </a>
        </div>
    </nav>

    <section id="home" class="relative min-h-screen flex items-center justify-center pt-20 overflow-hidden">
        <div id="hero-bg" class="absolute inset-0 z-0">
            <img src="https://images.unsplash.com/photo-1466692476868-aef1dfb1e735?q=80&w=2600&auto=format&fit=crop" class="w-full h-full object-cover opacity-30">
        </div>
        <div id="hero-content" class="container mx-auto px-6 relative z-10 text-center">
            <h1 class="font-serif text-6xl md:text-7xl font-bold text-white mb-6">AI Architecture for<br><span class="text-neon-lime">Every Professional</span></h1>
            <a href="#design" class="bg-neon-lime text-botanical-900 px-8 py-3 rounded-xl font-bold hover:bg-white transition">Start New Project</a>
        </div>
    </section>

    <section id="design" class="py-24 relative">
        <div class="container mx-auto px-4 max-w-5xl">
            <div class="glass-panel rounded-3xl p-8 shadow-2xl bg-slate-900/50">
                <form action="/generate" method="post" enctype="multipart/form-data">
                    <div class="mb-10 p-6 bg-slate-800/50 rounded-2xl border border-neon-lime/30">
                        <label class="block text-sm font-bold text-neon-lime uppercase tracking-widest mb-4">Select Your Role</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label class="cursor-pointer"><input type="radio" name="user_persona" value="Homeowner" class="peer sr-only" checked><div class="p-4 rounded-xl border border-slate-600 hover:bg-slate-700 peer-checked:bg-botanical-500 peer-checked:text-botanical-900 peer-checked:border-neon-lime transition text-center"><i class="fas fa-home text-2xl mb-2"></i><div class="font-bold">Homeowner (B2C)</div><div class="text-xs text-slate-400 mt-1">Quick garden design, focus on visuals, budget, ease</div></div></label>
                            <label class="cursor-pointer"><input type="radio" name="user_persona" value="Landscaping Business" class="peer sr-only"><div class="p-4 rounded-xl border border-slate-600 hover:bg-slate-700 peer-checked:bg-botanical-500 peer-checked:text-botanical-900 peer-checked:border-neon-lime transition text-center"><i class="fas fa-building text-2xl mb-2"></i><div class="font-bold">Landscaping Business (B2B)</div><div class="text-xs text-slate-400 mt-1">Multiple designs, client-ready proposals, project management</div></div></label>
                            <label class="cursor-pointer"><input type="radio" name="user_persona" value="Admin" class="peer sr-only"><div class="p-4 rounded-xl border border-slate-600 hover:bg-slate-700 peer-checked:bg-botanical-500 peer-checked:text-botanical-900 peer-checked:border-neon-lime transition text-center"><i class="fas fa-cog text-2xl mb-2"></i><div class="font-bold">Admin</div><div class="text-xs text-slate-400 mt-1">Manage plant database, update climate rules, monitor AI</div></div></label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="space-y-4">
                            <input type="text" name="project_type" value="Residential" class="hidden">
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Total Area (Sq Ft)</label><input type="number" name="dimensions" value="1500" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Budget</label><input type="number" name="user_budget" value="50000" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Zip Code</label><input type="text" name="zip_code" value="10001" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"></div>
                        </div>
                        <div class="space-y-4">
                             <div><label class="text-xs font-bold text-slate-500 uppercase">Quality</label><select name="quality_tier" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"><option value="Economy">Economy</option><option value="Standard" selected>Standard</option><option value="Premium">Premium</option></select></div>
                             <div><label class="text-xs font-bold text-slate-500 uppercase">Soil Type</label><select name="soil" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"><option value="Loam">Loam</option><option value="Clay">Clay</option><option value="Sandy">Sandy</option></select></div>
                             <div><label class="text-xs font-bold text-slate-500 uppercase">Climate</label><select name="climate" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"><option value="Temperate">Temperate</option><option value="Subtropical">Subtropical</option><option value="Continental">Continental</option><option value="Arid">Arid</option><option value="Mediterranean">Mediterranean</option></select></div>
                        </div>
                        <div class="space-y-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Currency</label><select name="currency" id="currency-select" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"><option value="USD">USD</option><option value="INR">INR</option><option value="EUR">EUR</option></select></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Maintenance Level</label><select name="maintenance_level" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"><option value="Low">Low</option><option value="Medium" selected>Medium</option><option value="High">High</option></select></div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Site Plan</label>
                                <label for="file-upload" class="w-full mt-1 cursor-pointer bg-slate-800 text-slate-400 p-3 rounded-lg border border-slate-700 transition duration-200 focus-within:border-neon-lime focus-within:ring-2 focus-within:ring-neon-lime/30 flex items-center justify-center text-sm hover:bg-slate-700">
                                    <i class="fas fa-upload mr-2"></i>
                                    <span id="file-upload-filename">Upload File</span>
                                </label>
                                <input id="file-upload" type="file" name="file" required class="hidden">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Style</label><select name="style" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"><option value="Modern">Modern</option><option value="Traditional">Traditional</option><option value="Rustic">Rustic</option><option value="Minimalist">Minimalist</option></select></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Terrain</label><select name="terrain" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"><option value="Flat">Flat</option><option value="Hilly">Hilly</option><option value="Sloped">Sloped</option></select></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Usage</label><select name="usage" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"><option value="Family">Family</option><option value="Entertainment">Entertainment</option><option value="Relaxation">Relaxation</option></select></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Privacy</label><select name="privacy" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30"><option value="Semi-Private">Semi-Private</option><option value="Private">Private</option><option value="Open">Open</option></select></div>
                    </div>

                    <div class="mb-8">
                        <label class="text-xs font-bold text-slate-500 uppercase">Water Feature</label>
                        <select name="water_feature" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30">
                            <option value="None">None</option>
                            <option value="Swimming Pool">Swimming Pool</option>
                            <option value="Koi Pond">Koi Pond</option>
                            <option value="Fountain">Fountain</option>
                        </select>
                    </div>
                    <div class="mb-6 flex items-center">
                        <input type="checkbox" id="bulk-mode" name="bulk_mode" value="on" class="mr-3">
                        <label for="bulk-mode" class="text-slate-300">Generate Bulk Variations (3 different designs)</label>
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-botanical-500 to-neon-lime text-botanical-900 font-bold text-lg py-4 rounded-xl">GENERATE PLAN</button>
                </form>
            </div>
        </div>
    </section>

    <section id="results" class="py-20 bg-slate-900 scroll-mt-24 {% if not result %}hidden{% endif %}">
        <div class="container mx-auto px-4 max-w-7xl">
            <div class="glass-panel p-8 rounded-2xl mb-12 border-l-8 border-neon-lime" id="summary-panel">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-3xl font-serif text-white mb-2">Cost Estimation</h2>
                        <p id="budget-status" class="font-bold text-lg {% if result %}{{ status_color }}{% endif %}">{% if result %}{{ budget_status }}{% endif %}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Total</p>
                        <p id="total-cost" class="text-5xl font-serif text-neon-lime">{% if result %}{{ cost }}{% endif %}</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-16">
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-xl font-serif text-white mb-6">Bill of Materials</h3>
                    <div id="bom-container">
                        {% if result %}
                        <table class="w-full text-left text-sm text-slate-300">
                            <thead class="text-xs uppercase bg-slate-800 text-slate-400"><tr><th class="px-4 py-3">Item</th><th class="px-4 py-3 text-right">Cost</th></tr></thead>
                            <tbody class="divide-y divide-slate-700">
                                {% for item in bom %}<tr><td class="px-4 py-3 text-white">{{ item.name }}</td><td class="px-4 py-3 text-right font-bold text-neon-lime">{{ item.total }}</td></tr>{% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    </div>
                </div>

                <div class="glass-panel p-2 rounded-2xl relative">
                    <div id="img-loader" class="absolute inset-0 bg-slate-900/80 z-10 hidden flex items-center justify-center"><i class="fas fa-circle-notch animate-spin text-neon-lime text-3xl"></i></div>
                    <p class="text-center text-xs uppercase font-bold text-slate-500 py-2">AI View</p>
                    <img id="render-img" src="{% if result %}{{ url_3d }}{% endif %}" class="w-full rounded-xl transition duration-500">
                </div>
            </div>

            {% if result %}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-16">
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-xl font-serif text-white mb-6">Seasonal Plant Recommendations ({{ current_season }})</h3>
                    <div class="space-y-4">
                        {% for plant in recommended_plants %}
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <h4 class="text-neon-lime font-bold">{{ plant.name }}</h4>
                            <p class="text-slate-300 text-sm">{{ plant.season }} plant, suitable for {{ plant.soil_types|join(', ') }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-xl font-serif text-white mb-6">Maintenance Schedule</h3>
                    <div class="space-y-4">
                        {% for task in maintenance_schedule %}
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <h4 class="text-neon-lime font-bold">{{ task.plant }}</h4>
                            <ul class="text-slate-300 text-sm space-y-1">
                                <li><strong>Watering:</strong> {{ task.watering }}</li>
                                <li><strong>Pruning:</strong> {{ task.pruning }}</li>
                                <li><strong>Fertilizing:</strong> {{ task.fertilizing }}</li>
                            </ul>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    {% if bulk_plans %}
    <section id="bulk-results" class="py-20 bg-slate-900">
        <div class="container mx-auto px-4 max-w-7xl">
            <h2 class="text-4xl font-serif text-white mb-12 text-center">Bulk Design Variations</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                {% for plan in bulk_plans %}
                <div class="glass-panel p-6 rounded-2xl">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-serif text-white mb-2">Variation {{ loop.index }}</h3>
                        <p class="text-neon-lime font-bold text-xl">{{ plan.cost }}</p>
                        <p class="text-sm text-slate-300">{{ plan.state.style }} Style - {{ plan.state.quality_tier }} Tier</p>
                    </div>
                    <img src="{{ plan.url_3d }}" class="w-full rounded-xl mb-4" alt="Design Variation {{ loop.index }}">
                    <div class="space-y-2 text-sm">
                        <p><strong>Style:</strong> {{ plan.state.style }}</p>
                        <p><strong>Quality:</strong> {{ plan.state.quality_tier }}</p>
                        <p><strong>Budget:</strong> {{ plan.state.user_budget }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    <section id="schedule" class="py-24 relative">
        <div class="container mx-auto px-4 max-w-4xl">
            <div class="glass-panel rounded-3xl p-8 shadow-2xl bg-slate-900/50">
                <h2 class="text-3xl font-serif text-white mb-8 text-center">Schedule a Consultation</h2>
                <form id="schedule-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Name</label><input type="text" name="name" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30" required></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Email</label><input type="email" name="email" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30" required></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Phone</label><input type="tel" name="phone" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30" required></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Preferred Date</label><input type="date" name="date" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30" required></div>
                    </div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Message</label><textarea name="message" rows="4" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 outline-none transition duration-200 focus:border-neon-lime focus:ring-2 focus:ring-neon-lime/30" placeholder="Tell us about your project..."></textarea></div>
                    <button type="submit" class="w-full bg-gradient-to-r from-botanical-500 to-neon-lime text-botanical-900 font-bold text-lg py-4 rounded-xl transition-opacity duration-300 disabled:opacity-50">Schedule Appointment</button>
                    <div id="schedule-form-status" class="text-center mt-4 h-6"></div>
                </form>
            </div>
        </div>
    </section>

    {% if result %}<script>document.getElementById('results').scrollIntoView();</script>{% endif %}
    {% if bulk_plans %}<script>document.getElementById('bulk-results').scrollIntoView();</script>{% endif %}

    <div class="fixed bottom-8 right-8 z-50 flex flex-col items-end font-sans">
        <button onclick="toggleChat()" class="bg-gradient-to-r from-botanical-500 to-neon-lime w-16 h-16 rounded-full shadow-[0_0_20px_rgba(16,185,129,0.5)] flex items-center justify-center transition transform hover:scale-110 group">
            <i class="fas fa-comment-dots text-3xl text-botanical-900"></i>
        </button>

        <div id="chat-ui" class="hidden absolute bottom-24 right-0 w-96 glass-panel rounded-2xl overflow-hidden shadow-2xl border border-slate-700 flex flex-col h-[500px]">
            <div class="bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-botanical-500 flex items-center justify-center"><i class="fas fa-robot text-botanical-900"></i></div>
                    <div><span class="text-white font-bold text-sm block">Virtual Assistant</span><span class="text-neon-lime text-[10px] uppercase font-bold">Online</span></div>
                </div>
                <button onclick="toggleChat()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 bg-slate-900/90 space-y-4 text-sm">
                <div class="flex justify-start chat-msg"><div class="bg-slate-800 text-slate-200 p-3 rounded-2xl rounded-tl-none max-w-[85%] border border-slate-700">Hi! I've analyzed your project. Try asking about **Soil**, **Budget**, or **Design Changes**.</div></div>
            </div>
            <div id="chat-loading" class="hidden px-4 pb-2"><div class="flex gap-1 bg-slate-800 w-12 p-2 rounded-full"><div class="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div><div class="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div><div class="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div></div></div>
            <div class="p-3 bg-slate-800 border-t border-slate-700 flex gap-2">
                <input type="text" id="chat-input" placeholder="Type your request..." class="flex-1 bg-slate-900 text-white text-sm p-3 rounded-xl border border-slate-700 focus:border-neon-lime outline-none">
                <button onclick="sendMsg()" class="bg-neon-lime text-botanical-900 p-3 rounded-xl hover:bg-white transition"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        let projectState = JSON.parse(document.body.dataset.currentState);

        function toggleChat() { document.getElementById('chat-ui').classList.toggle('hidden'); }

        async function sendMsg() {
            const inp = document.getElementById('chat-input');
            const box = document.getElementById('chat-box');
            const loader = document.getElementById('chat-loading');
            if(!inp.value) return;
            const msg = inp.value;
            box.innerHTML += `<div class="flex justify-end chat-msg"><div class="bg-botanical-500 text-botanical-900 font-bold p-3 rounded-2xl rounded-tr-none max-w-[85%]">${msg}</div></div>`;
            inp.value = '';
            box.scrollTop = box.scrollHeight;
            loader.classList.remove('hidden');

            try {
                const res = await fetch('/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ message: msg, current_state: projectState }) });
                const data = await res.json();
                loader.classList.add('hidden');
                box.innerHTML += `<div class="flex justify-start chat-msg"><div class="bg-slate-800 text-slate-200 p-3 rounded-2xl rounded-tl-none max-w-[85%] border border-slate-700">${data.reply}</div></div>`;
                box.scrollTop = box.scrollHeight;
                if(data.updated) {
                    projectState = data.new_plan.state;
                    updateUI(data.new_plan);
                }
            } catch (err) {
                loader.classList.add('hidden');
                box.innerHTML += `<div class="flex justify-start text-red-400 text-xs">Connection Error.</div>`;
            }
        }

        function updateUI(plan) {
            const resultsSection = document.getElementById('results');
            if (resultsSection.classList.contains('hidden')) {
                resultsSection.classList.remove('hidden');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            const panel = document.getElementById('summary-panel');
            panel.classList.add('ring-2', 'ring-neon-lime');
            setTimeout(() => panel.classList.remove('ring-2', 'ring-neon-lime'), 500);

            document.getElementById('total-cost').innerText = plan.cost;
            document.getElementById('budget-status').innerText = plan.budget_status;
            document.getElementById('budget-status').className = `font-bold text-lg ${plan.status_color}`;

            const bomContainer = document.getElementById('bom-container');
            bomContainer.innerHTML = ''; // Clear previous content
            const table = document.createElement('table');
            table.className = 'w-full text-left text-sm text-slate-300';
            table.innerHTML = `<thead class="text-xs uppercase bg-slate-800 text-slate-400"><tr><th class="px-4 py-3">Item</th><th class="px-4 py-3 text-right">Cost</th></tr></thead>`;
            const tbody = document.createElement('tbody');
            tbody.className = 'divide-y divide-slate-700';
            plan.bom.forEach(item => {
                const row = tbody.insertRow();
                row.insertCell().textContent = item.name;
                row.cells[0].className = 'px-4 py-3 text-white';
                row.insertCell().textContent = item.total;
                row.cells[1].className = 'px-4 py-3 text-right font-bold text-neon-lime';
            });
            table.appendChild(tbody);
            bomContainer.appendChild(table);

            const imgLoader = document.getElementById('img-loader');
            const renderImg = document.getElementById('render-img');
            imgLoader.classList.remove('hidden');
            imgLoader.classList.add('flex');
            renderImg.style.opacity = '0.5';
            const newImg = new Image();
            newImg.src = plan.url_3d;
            newImg.onload = () => { renderImg.src = plan.url_3d; renderImg.style.opacity = '1'; imgLoader.classList.add('hidden'); imgLoader.classList.remove('flex'); };
        }

        document.getElementById('chat-input').addEventListener('keypress', function (e) { if (e.key === 'Enter') sendMsg(); });
        
        document.addEventListener("DOMContentLoaded", function() {
            // Currency auto-selection
            const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const select = document.getElementById('currency-select');
            if (select) {
                if (tz.includes('Europe')) select.value = 'EUR';
                else if (tz.includes('India')) select.value = 'INR';
                else select.value = 'USD';
            }

            // 3D Parallax Scroll Effect
            const heroSection = document.getElementById('home');
            const heroBg = document.getElementById('hero-bg');
            const heroContent = document.getElementById('hero-content');
            if (heroSection && heroBg && heroContent) {
                heroBg.style.transform = 'scale(1.3)'; // Increase initial scale for more dramatic movement
                window.addEventListener('scroll', () => {
                    const offset = window.pageYOffset;
                    if (offset < heroSection.offsetHeight) {
                        const scrollPercent = offset / heroSection.offsetHeight;
                        // Move background faster for more depth
                        heroBg.style.transform = `translateY(${offset * 0.7}px) scale(1.3)`;
                        // Move content and shrink it faster for a more dramatic effect
                        heroContent.style.transform = `translateY(${offset * 0.3}px) scale(${1 - scrollPercent * 0.4})`;
                        heroContent.style.opacity = 1 - scrollPercent * 1.5;
                    }
                }, { passive: true });
            }

            // Custom file input handler
            const fileInput = document.getElementById('file-upload');
            const fileInputName = document.getElementById('file-upload-filename');
            if (fileInput && fileInputName) {
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length > 0) {
                        fileInputName.textContent = fileInput.files[0].name;
                    } else {
                        fileInputName.textContent = 'Upload File';
                    }
                });
            }

            // Schedule form handler
            const scheduleForm = document.getElementById('schedule-form');
            const scheduleFormStatus = document.getElementById('schedule-form-status');
            if (scheduleForm && scheduleFormStatus) {
                scheduleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitButton = scheduleForm.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.innerHTML;

                    submitButton.innerHTML = 'Sending...';
                    submitButton.disabled = true;
                    scheduleFormStatus.textContent = '';

                    const formData = new FormData(scheduleForm);
                    try {
                        const res = await fetch('/schedule', {
                            method: 'POST',
                            body: formData
                        });
                        const result = await res.json();
                        if (res.ok) {
                            scheduleFormStatus.className = 'text-center mt-4 h-6 text-neon-lime';
                            scheduleForm.reset();
                        } else {
                            scheduleFormStatus.className = 'text-center mt-4 h-6 text-red-400';
                        }
                        scheduleFormStatus.textContent = result.message;
                    } catch (err) {
                        scheduleFormStatus.className = 'text-center mt-4 h-6 text-red-400';
                        scheduleFormStatus.textContent = 'Network error. Please check your connection and try again.';
                    } finally {
                        submitButton.innerHTML = originalButtonText;
                        submitButton.disabled = false;
                    }
                });
            }
        });
    </script>
</body>
</html>